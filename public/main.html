<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guardian Angel - Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body { font-family: Arial, sans-serif; margin:0; padding:0; }
        header { background:#ff3b6c; color:white; padding:15px; display:flex; justify-content:space-between; align-items:center; }
        button { padding:10px 15px; margin:5px; cursor:pointer; border:none; border-radius:5px; }
        #map { height:400px; margin:15px; }
        .contact-list { margin:15px; }
        .contact-item { margin-bottom:5px; }
        .sos-button { background:#ff3b6c; color:white; font-size:18px; padding:15px 25px; border-radius:50%; box-shadow:0 10px 30px rgba(255,59,108,0.4); transition:0.3s; }
        .sos-button:hover { transform:scale(1.1); box-shadow:0 0 30px rgba(255,59,108,0.8); }
    </style>
</head>
<body>

<header>
    <div id="welcomeUser">Welcome</div>
    <button id="logoutBtn">Logout</button>
</header>

<section class="emergency-contacts">
    <h3>Emergency Contacts</h3>
    <div class="contact-list" id="contactList"></div>
    <input type="text" id="newContact" placeholder="Enter phone number (+91xxxxxxx)">
    <button id="addContactBtn">Add Contact</button>
</section>

<section>
    <button class="sos-button" id="sosBtn">SOS</button>
</section>

<section>
    <h3>Nearby Safe Places</h3>
    <div id="map"></div>
</section>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
    // ------------------- Session Handling -------------------
    const userId = localStorage.getItem('userId');
    const userName = localStorage.getItem('userName');
    if(!userId) {
        alert('Login session expired');
        window.location.href = 'index.html';
    } else {
        document.getElementById('welcomeUser').innerText = `Welcome, ${userName}`;
    }

    document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.clear();
        window.location.href = 'index.html';
    });

    // ------------------- Emergency Contacts -------------------
    const contactListEl = document.getElementById('contactList');
    let emergencyContacts = JSON.parse(localStorage.getItem('emergencyContacts')) || [];

    function renderContacts(){
        contactListEl.innerHTML = '';
        emergencyContacts.forEach((c,i) => {
            const div = document.createElement('div');
            div.classList.add('contact-item');
            div.innerText = c;
            const removeBtn = document.createElement('button');
            removeBtn.innerText = 'Remove';
            removeBtn.addEventListener('click', () => {
                emergencyContacts.splice(i,1);
                saveContacts();
            });
            div.appendChild(removeBtn);
            contactListEl.appendChild(div);
        });
    }

    function saveContacts(){
        localStorage.setItem('emergencyContacts', JSON.stringify(emergencyContacts));
        renderContacts();
        // Update MongoDB
        fetch('/updateContacts', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({userId, emergencyContacts})
        });
    }

    document.getElementById('addContactBtn').addEventListener('click', () => {
        const number = document.getElementById('newContact').value.trim();
        if(number && !emergencyContacts.includes(number)){
            emergencyContacts.push(number);
            document.getElementById('newContact').value='';
            saveContacts();
        }
    });

    renderContacts();

    // ------------------- SOS -------------------
    document.getElementById('sosBtn').addEventListener('click', async () => {
        if(emergencyContacts.length === 0){
            alert('Add emergency contacts first!');
            return;
        }
        if(!navigator.geolocation){
            alert('Geolocation not supported by your browser');
            return;
        }
        navigator.geolocation.getCurrentPosition(async pos => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;

            const res = await fetch('/sos', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({userId, lat, lng})
            });
            const data = await res.json();
            alert(data.success ? 'SOS sent successfully!' : 'Failed to send SOS: '+data.message);
        }, err => {
            alert('Failed to get location');
        });
    });

    // ------------------- Nearby Safe Places Map -------------------
    const map = L.map('map').setView([20.5937,78.9629],5); // India center
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        attribution:'&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Get current location
    navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        map.setView([lat,lng],13);
        L.marker([lat,lng]).addTo(map).bindPopup('You are here').openPopup();

        // Fetch nearby police/hospital using Overpass API
        const overpassQuery = `
            [out:json];
            (
              node["amenity"="police"](around:3000,${lat},${lng});
              node["amenity"="hospital"](around:3000,${lat},${lng});
            );
            out;
        `;
        fetch('https://overpass-api.de/api/interpreter',{
            method:'POST',
            body: overpassQuery
        })
        .then(res => res.json())
        .then(data => {
            data.elements.forEach(e => {
                const name = e.tags.name || e.tags.amenity;
                L.marker([e.lat,e.lon]).addTo(map).bindPopup(name);
            });
        });
    });
});
</script>
</body>
</html>
