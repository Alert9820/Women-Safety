<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guardian Angel - Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        
        :root {
            --primary: #ff3b6c;
            --secondary: #5e17eb;
            --dark: #1e1c2a;
            --light: #f8f9fa;
            --gray: #6c757d;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            color: var(--dark);
            min-height: 100vh;
        }
        
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, var(--dark) 0%, #2d2b3a 100%);
            color: white;
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            box-shadow: 5px 0 15px rgba(0,0,0,0.1);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }
        
        .logo i {
            color: var(--primary);
            font-size: 28px;
        }
        
        .logo h1 {
            font-size: 22px;
            font-weight: 700;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            gap: 15px;
            background: rgba(255,255,255,0.05);
            margin: 0 15px 20px;
            border-radius: 12px;
        }
        
        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 600;
            color: white;
        }
        
        .user-info h3 {
            font-size: 16px;
            margin-bottom: 5px;
            color: white;
        }
        
        .user-info p {
            font-size: 12px;
            color: var(--gray);
        }
        
        .nav-menu {
            flex: 1;
            padding: 10px 0;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 25px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            cursor: pointer;
        }
        
        .nav-item:hover, .nav-item.active {
            background: rgba(255,255,255,0.1);
            border-left: 4px solid var(--primary);
            color: white;
        }
        
        .nav-item i {
            width: 20px;
            text-align: center;
            font-size: 18px;
        }
        
        .logout-btn {
            margin: 20px;
            padding: 12px 20px;
            background: rgba(255,59,108,0.2);
            color: var(--primary);
            border: 1px solid var(--primary);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        
        .logout-btn:hover {
            background: var(--primary);
            color: white;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }
        
        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
        }
        
        .btn {
            padding: 12px 25px;
            border-radius: 50px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .btn-primary {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 4px 15px rgba(255, 59, 108, 0.3);
        }
        
        .btn-outline {
            background: transparent;
            color: var(--dark);
            border: 2px solid var(--dark);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.12);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }
        
        /* SOS Button */
        .sos-section {
            text-align: center;
            margin: 30px 0;
        }
        
        .sos-button {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 28px;
            font-weight: 700;
            box-shadow: 0 15px 40px rgba(255, 59, 108, 0.4);
            cursor: pointer;
            margin: 0 auto;
            transition: all 0.3s ease;
            position: relative;
            animation: pulse 2s infinite;
            border: none;
        }
        
        .sos-button:hover {
            transform: scale(1.05);
            box-shadow: 0 20px 50px rgba(255, 59, 108, 0.6);
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 59, 108, 0.7);
            }
            70% {
                box-shadow: 0 0 0 25px rgba(255, 59, 108, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 59, 108, 0);
            }
        }
        
        .sos-label {
            margin-top: 15px;
            color: var(--gray);
            font-size: 14px;
        }
        
        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .action-btn {
            background: var(--light);
            border-radius: 12px;
            padding: 20px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .action-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-color: var(--primary);
        }
        
        .action-btn i {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .action-btn div {
            font-size: 12px;
            font-weight: 500;
            color: var(--dark);
        }
        
        /* Contacts */
        .contact-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .contact-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            transition: background 0.3s ease;
        }
        
        .contact-item:hover {
            background: var(--light);
        }
        
        .contact-item:last-child {
            border-bottom: none;
        }
        
        .contact-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .contact-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--info);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
        }
        
        .contact-details h4 {
            font-size: 14px;
            margin-bottom: 2px;
        }
        
        .contact-details p {
            font-size: 12px;
            color: var(--gray);
        }
        
        .remove-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .add-contact-form {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .add-contact-form input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        
        /* Map Section */
        .map-section {
            margin-top: 30px;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            color: var(--primary);
        }
        
        #map {
            height: 400px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            border: 3px solid white;
        }

        /* Notification Styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            z-index: 10000;
            max-width: 300px;
            animation: slideIn 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .notification.success {
            background: var(--success);
        }

        .notification.error {
            background: var(--danger);
        }

        .notification.warning {
            background: var(--warning);
        }

        .notification.info {
            background: var(--info);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Fake Call Overlay */
        .fake-call-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 10000;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-family: Arial, sans-serif;
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                padding: 15px;
            }
            
            .sos-button {
                width: 150px;
                height: 150px;
                font-size: 24px;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .header-actions {
                flex-direction: column;
                width: 100%;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <i class="fas fa-shield-alt"></i>
                <h1>Guardian Angel</h1>
            </div>
            
            <div class="user-profile">
                <div class="user-avatar" id="userAvatar">U</div>
                <div class="user-info">
                    <h3 id="userName">User</h3>
                    <p id="userPhone">+91 XXXXX XXXXX</p>
                </div>
            </div>
            
            <div class="nav-menu">
                <a href="#" class="nav-item active" onclick="setActiveNav(this)">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a href="sos.html" class="nav-item" onclick="setActiveNav(this)">
                    <i class="fas fa-bell"></i>
                    <span>Emergency SOS</span>
                </a>
                <a href="location.html" class="nav-item" onclick="setActiveNav(this)">
                    <i class="fas fa-location-arrow"></i>
                    <span>Location Sharing</span>
                </a>
                <a href="safe-places.html" class="nav-item" onclick="setActiveNav(this)">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>Safe Places</span>
                </a>
                <a href="community.html" class="nav-item" onclick="setActiveNav(this)">
                    <i class="fas fa-users"></i>
                    <span>Community Alerts</span>
                </a>
                <a href="fake-call.html" class="nav-item" onclick="setActiveNav(this)">
                    <i class="fas fa-phone"></i>
                    <span>Fake Call</span>
                </a>
                <a href="settings.html" class="nav-item" onclick="setActiveNav(this)">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </div>
            
            <button class="logout-btn" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </button>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h2 class="page-title">Safety Dashboard</h2>
                <div class="header-actions">
                    <button class="btn btn-outline">
                        <i class="fas fa-bell"></i>
                        Notifications
                    </button>
                    <button class="btn btn-primary" id="addContactMainBtn">
                        <i class="fas fa-plus"></i>
                        Add Emergency Contact
                    </button>
                </div>
            </div>
            
            <div class="dashboard-grid">
                <!-- SOS Card -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Emergency SOS</h3>
                        <div class="card-icon">
                            <i class="fas fa-bell"></i>
                        </div>
                    </div>
                    <div class="sos-section">
                        <button class="sos-button" id="sosBtn">
                            SOS
                        </button>
                        <div class="sos-label">
                            Press in case of emergency. Your location will be shared immediately.
                        </div>
                    </div>
                </div>
                
                <!-- Safety Status Card -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Safety Status</h3>
                        <div class="card-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                    </div>
                    <div style="text-align: center; margin: 20px 0;">
                        <div style="font-size: 48px; color: var(--success); margin: 15px 0;">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <h3 style="color: var(--success); margin-bottom: 10px;">All Systems Active</h3>
                        <p style="color: var(--gray);">Your safety features are enabled and working</p>
                    </div>
                    
                    <div class="quick-actions">
                        <div class="action-btn" id="shareLocationBtn">
                            <i class="fas fa-location-arrow"></i>
                            <div>Share Location</div>
                        </div>
                        <div class="action-btn" id="safePlacesBtn">
                            <i class="fas fa-map-marker-alt"></i>
                            <div>Safe Places</div>
                        </div>
                        <div class="action-btn" id="fakeCallBtn">
                            <i class="fas fa-phone"></i>
                            <div>Fake Call</div>
                        </div>
                        <div class="action-btn" id="soundAlarmBtn">
                            <i class="fas fa-bullhorn"></i>
                            <div>Sound Alarm</div>
                        </div>
                    </div>
                </div>
                
                <!-- Emergency Contacts Card -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Emergency Contacts</h3>
                        <div class="card-icon">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                    
                    <div class="contact-list" id="contactList">
                        <!-- Contacts will be loaded here -->
                    </div>
                    
                    <div class="add-contact-form">
                        <input type="text" id="newContact" placeholder="Enter phone number (+91xxxxxxxxxx)" maxlength="13">
                        <button class="btn btn-primary" id="addContactBtn">
                            <i class="fas fa-plus"></i>
                            Add
                        </button>
                    </div>
                </div>
                
                <!-- Recent Activity Card -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Recent Activity</h3>
                        <div class="card-icon">
                            <i class="fas fa-history"></i>
                        </div>
                    </div>
                    <div style="text-align: center; padding: 20px;">
                        <i class="fas fa-check-circle" style="font-size: 48px; color: var(--success); margin-bottom: 15px;"></i>
                        <h4 style="color: var(--success); margin-bottom: 10px;">No Recent Alerts</h4>
                        <p style="color: var(--gray); font-size: 14px;">Everything is safe and secure</p>
                    </div>
                </div>
            </div>
            
            <!-- Nearby Safe Places Section -->
            <div class="map-section">
                <h3 class="section-title">
                    <i class="fas fa-map-marked-alt"></i>
                    Nearby Safe Places
                </h3>
                <div id="map"></div>
            </div>
        </div>
    </div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    // ===== GLOBAL VARIABLES =====
    let map;
    let emergencyContacts = JSON.parse(localStorage.getItem('emergencyContacts')) || [];

    // ===== SESSION MANAGEMENT =====
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Dashboard Loading...');
        
        // Check if user is logged in
        const userId = localStorage.getItem('userId');
        const userName = localStorage.getItem('userName');
        const userPhone = localStorage.getItem('userPhone');
        
        console.log('User Data:', { userId, userName, userPhone });
        
        if (!userId) {
            alert('Please login first');
            window.location.href = 'index.html';
            return;
        }

        // Update user info in sidebar
        document.getElementById('userName').textContent = userName || 'User';
        document.getElementById('userPhone').textContent = userPhone || '+91 XXXXX XXXXX';
        document.getElementById('userAvatar').textContent = userName ? userName.charAt(0).toUpperCase() : 'U';

        // Initialize all features
        initializeDashboard();

        // ===== LOGOUT FUNCTION =====
        document.getElementById('logoutBtn').addEventListener('click', function() {
            console.log('Logout clicked');
            localStorage.clear();
            showNotification('Logged out successfully', 'success');
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 1000);
        });

        // ===== ADD CONTACT BUTTONS =====
        document.getElementById('addContactBtn').addEventListener('click', addContact);
        document.getElementById('addContactMainBtn').addEventListener('click', function() {
            document.getElementById('newContact').focus();
        });

        // ===== SOS BUTTON =====
        document.getElementById('sosBtn').addEventListener('click', triggerSOS);

        // ===== QUICK ACTIONS =====
        document.getElementById('fakeCallBtn').addEventListener('click', triggerFakeCall);
        document.getElementById('shareLocationBtn').addEventListener('click', shareLiveLocation);
        document.getElementById('safePlacesBtn').addEventListener('click', function() {
            document.getElementById('map').scrollIntoView({ behavior: 'smooth' });
        });
        document.getElementById('soundAlarmBtn').addEventListener('click', triggerAlarm);

        // ===== ENTER KEY FOR ADD CONTACT =====
        document.getElementById('newContact').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addContact();
            }
        });

        // ===== KEYBOARD SHORTCUT FOR SOS =====
        document.addEventListener('keydown', function(event) {
            if (event.code === 'Space' && event.target.tagName !== 'INPUT') {
                event.preventDefault();
                triggerSOS();
            }
        });

        console.log('‚úÖ Dashboard initialized successfully');
    });

    // ===== SIDEBAR NAVIGATION =====
    function setActiveNav(element) {
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        element.classList.add('active');
    }

    // ===== NOTIFICATION SYSTEM =====
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-triangle' : 'bell'}"></i>
                <span>${message}</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 4000);
    }

    // ===== EMERGENCY CONTACTS MANAGEMENT =====
    function loadContacts() {
        const contactListEl = document.getElementById('contactList');
        
        if (emergencyContacts.length === 0) {
            contactListEl.innerHTML = `
                <div style="text-align: center; padding: 20px; color: var(--gray);">
                    <i class="fas fa-users" style="font-size: 48px; margin-bottom: 10px;"></i>
                    <p>No emergency contacts added</p>
                    <p style="font-size: 12px; margin-top: 10px;">Add contacts to send emergency alerts</p>
                </div>
            `;
            return;
        }

        contactListEl.innerHTML = emergencyContacts.map((contact, index) => `
            <div class="contact-item">
                <div class="contact-info">
                    <div class="contact-avatar" style="background: ${getRandomColor()};">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="contact-details">
                        <h4>Emergency Contact ${index + 1}</h4>
                        <p>${formatPhoneNumber(contact)}</p>
                    </div>
                </div>
                <button class="remove-btn" onclick="removeContact(${index})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `).join('');
    }

    function getRandomColor() {
        const colors = ['#ff3b6c', '#5e17eb', '#28a745', '#17a2b8', '#ffc107'];
        return colors[Math.floor(Math.random() * colors.length)];
    }

    function formatPhoneNumber(phone) {
        return phone.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
    }

    function removeContact(index) {
        emergencyContacts.splice(index, 1);
        localStorage.setItem('emergencyContacts', JSON.stringify(emergencyContacts));
        loadContacts();
        showNotification('Contact removed successfully', 'success');
    }

    function addContact() {
        const numberInput = document.getElementById('newContact');
        const number = numberInput.value.trim();
        const phoneRegex = /^(\+91[\-\s]?)?[0]?(91)?[6789]\d{9}$/;
        
        if (!number) {
            showNotification('Please enter a phone number', 'error');
            return;
        }
        
        // Clean the number
        const cleanNumber = number.replace(/\D/g, '');
        
        if (!phoneRegex.test(cleanNumber)) {
            showNotification('Please enter a valid Indian phone number', 'error');
            return;
        }
        
        if (emergencyContacts.includes(cleanNumber)) {
            showNotification('This number is already in your emergency contacts', 'error');
            return;
        }
        
        if (emergencyContacts.length >= 5) {
            showNotification('Maximum 5 emergency contacts allowed', 'error');
            return;
        }

        emergencyContacts.push(cleanNumber);
        localStorage.setItem('emergencyContacts', JSON.stringify(emergencyContacts));
        numberInput.value = '';
        loadContacts();
        showNotification('Contact added successfully!', 'success');
    }

    // ===== SOS FUNCTIONALITY WITH TIMEOUT HANDLING =====
    async function triggerSOS() {
        const userId = localStorage.getItem('userId');
        const userName = localStorage.getItem('userName');
        
        if (emergencyContacts.length === 0) {
            showNotification('Please add emergency contacts first!', 'error');
            document.getElementById('newContact').focus();
            return;
        }
        
        // Button animation
        const sosBtn = document.getElementById('sosBtn');
        const originalHTML = sosBtn.innerHTML;
        sosBtn.style.transform = 'scale(1.1)';
        sosBtn.style.boxShadow = '0 0 40px rgba(255, 59, 108, 0.8)';
        sosBtn.disabled = true;
        sosBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SENDING...';
        
        if (!navigator.geolocation) {
            showNotification('Geolocation not supported by your browser', 'error');
            resetSOSButton(sosBtn, originalHTML);
            return;
        }
        
        try {
            // Get current location
            const position = await new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                });
            });
            
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            console.log('üìç Location obtained:', { lat, lng });
            
            // ‚úÖ ADD TIMEOUT TO FETCH REQUEST
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 25000); // 25 seconds timeout
            
            const response = await fetch('/api/sos', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    userId, 
                    lat, 
                    lng, 
                    triggeredBy: 'button'
                }),
                signal: controller.signal // ‚úÖ ADD SIGNAL FOR TIMEOUT
            });

            clearTimeout(timeoutId); // ‚úÖ CLEAR TIMEOUT IF SUCCESS
            
            const data = await response.json();
            console.log('SOS Response:', data);
            
            if (data.success) {
                showNotification(`üö® ${data.message}`, 'success');
                
                // Emergency visual effects
                document.body.style.background = 'linear-gradient(135deg, #ff3b6c 0%, #5e17eb 100%)';
                document.body.style.color = 'white';
                
                setTimeout(() => {
                    document.body.style.background = 'linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%)';
                    document.body.style.color = 'var(--dark)';
                }, 3000);
                
            } else {
                showNotification(`‚ùå ${data.message}`, 'error');
            }
        } catch (error) {
            console.error('SOS Error:', error);
            // ‚úÖ BETTER ERROR HANDLING
            if (error.name === 'AbortError') {
                showNotification('‚ùå SMS service timeout. Please check your connection and try again.', 'error');
            } else {
                showNotification(`‚ùå SOS failed: ${error.message}`, 'error');
            }
        }
        
        resetSOSButton(sosBtn, originalHTML);
    }

    function resetSOSButton(button, originalHTML) {
        setTimeout(() => {
            button.style.transform = 'scale(1)';
            button.disabled = false;
            button.innerHTML = originalHTML;
        }, 2000);
    }

    // ===== VOLUME BUTTON SOS (BACKGROUND) =====
    let volumePressCount = 0;
    let lastVolumePress = 0;

    document.addEventListener('keydown', function(e) {
        if (e.code === 'VolumeUp' || e.code === 'VolumeDown') {
            const now = Date.now();
            
            if (now - lastVolumePress > 2000) {
                volumePressCount = 0;
            }
            
            volumePressCount++;
            lastVolumePress = now;
            
            if (volumePressCount >= 3) {
                volumePressCount = 0;
                showNotification('Volume SOS Triggered!', 'warning');
                triggerVolumeSOS();
            }
        }
    });

    async function triggerVolumeSOS() {
        const userId = localStorage.getItem('userId');
        if (emergencyContacts.length === 0) return;

        if (!navigator.geolocation) return;

        try {
            const position = await new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                    enableHighAccuracy: true,
                    timeout: 10000
                });
            });
            
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;

            // ‚úÖ ADD TIMEOUT TO VOLUME SOS TOO
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 25000);
            
            const response = await fetch('/api/sos/volume', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({userId, lat, lng}),
                signal: controller.signal
            });

            clearTimeout(timeoutId);
            
            const data = await response.json();
            
            if (data.success) {
                showNotification(`üîä ${data.message}`, 'success');
            } else {
                showNotification(`‚ùå ${data.message}`, 'error');
            }
        } catch (error) {
            console.log('Volume SOS error:', error);
            if (error.name === 'AbortError') {
                showNotification('‚ùå Volume SOS timeout. Please try again.', 'error');
            }
        }
    }

    // ===== FAKE CALL FEATURE =====
    function triggerFakeCall() {
        if (document.getElementById('fakeCallOverlay')) return;
        
        const fakeCallHTML = `
        <div id="fakeCallOverlay" class="fake-call-overlay">
            <div style="text-align:center;">
                <div style="font-size: 48px; margin-bottom: 20px;">üìû</div>
                <h2 style="margin-bottom: 5px; font-size: 28px;">Incoming Call</h2>
                <h3 style="margin-bottom: 5px; font-size: 24px;">Mom</h3>
                <p style="margin-bottom: 30px; opacity: 0.8; font-size: 16px;">+91 ‚óè‚óè‚óè‚óè‚óè ‚óè‚óè‚óè‚óè‚óè</p>
                <div style="display: flex; gap: 20px;">
                    <button id="acceptFakeCallBtn" style="background:#4CAF50; color:white; width: 60px; height: 60px; border:none; border-radius:50%; font-size: 24px; cursor:pointer; display: flex; align-items: center; justify-content: center;">
                        ‚úì
                    </button>
                    <button id="rejectFakeCallBtn" style="background:#f44336; color:white; width: 60px; height: 60px; border:none; border-radius:50%; font-size: 24px; cursor:pointer; display: flex; align-items: center; justify-content: center;">
                        ‚úï
                    </button>
                </div>
            </div>
        </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', fakeCallHTML);
        
        document.getElementById('acceptFakeCallBtn').addEventListener('click', function() {
            document.getElementById('fakeCallOverlay').innerHTML = `
                <div style="text-align:center;">
                    <div style="font-size: 48px; margin-bottom: 20px;">üìû</div>
                    <h2 style="margin-bottom: 10px;">Call Connected</h2>
                    <p style="margin: 20px 0; font-size: 16px;">Pretend conversation in progress...</p>
                    <button id="endFakeCallBtn" style="background:#f44336; color:white; padding: 15px 30px; border:none; border-radius:25px; cursor:pointer; font-size: 16px; display: flex; align-items: center; gap: 8px; margin: 0 auto;">
                        <i class="fas fa-phone-slash"></i> End Call
                    </button>
                </div>
            `;
            document.getElementById('endFakeCallBtn').addEventListener('click', function() {
                document.getElementById('fakeCallOverlay').remove();
                showNotification('Call ended', 'info');
            });
        });
        
        document.getElementById('rejectFakeCallBtn').addEventListener('click', function() {
            document.getElementById('fakeCallOverlay').remove();
            showNotification('Call rejected', 'info');
        });
    }

    // ===== NEARBY SAFE PLACES MAP =====
    function initializeMap() {
        // Wait for DOM to be ready
        setTimeout(() => {
            if (!document.getElementById('map')) {
                console.log('Map container not found');
                return;
            }
            
            try {
                console.log('Initializing map...');
                
                // ‚úÖ BETTER MAP INITIALIZATION
                if (typeof L === 'undefined') {
                    console.error('Leaflet not loaded');
                    showNotification('Map service loading...', 'warning');
                    setTimeout(initializeMap, 1000);
                    return;
                }
                
                map = L.map('map').setView([20.5937, 78.9629], 5);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors',
                    maxZoom: 18
                }).addTo(map);

                // Get user location and show nearby places
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        showUserLocation, 
                        showDefaultMap,
                        {
                            enableHighAccuracy: true,
                            timeout: 15000,
                            maximumAge: 60000
                        }
                    );
                } else {
                    showDefaultMap();
                }
                
                console.log('‚úÖ Map initialized successfully');
            } catch (error) {
                console.error('Map initialization error:', error);
                showNotification('Map loading failed. Refreshing...', 'error');
                setTimeout(initializeMap, 2000);
            }
        }, 1500);
    }

    function showUserLocation(position) {
        try {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            console.log('User location:', { lat, lng });
            
            map.setView([lat, lng], 14);
            
            // Add user marker
            const userIcon = L.divIcon({
                className: 'user-marker',
                html: '<div style="background: #ff3b6c; width: 25px; height: 25px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>',
                iconSize: [25, 25],
                iconAnchor: [12, 12]
            });
            
            const userMarker = L.marker([lat, lng], {icon: userIcon}).addTo(map);
            userMarker.bindPopup(`
                <div style="text-align: center;">
                    <h4 style="margin: 0 0 5px 0; color: #ff3b6c;">Your Location</h4>
                    <p style="margin: 0; font-size: 12px;">You are here</p>
                </div>
            `).openPopup();
            
            // Add circle around user location
            L.circle([lat, lng], {
                color: '#ff3b6c',
                fillColor: '#ff3b6c',
                fillOpacity: 0.1,
                radius: 1000
            }).addTo(map);
            
            // Load nearby safe places
            loadNearbyPlaces(lat, lng);
        } catch (error) {
            console.error('Error showing user location:', error);
            showDefaultMap();
        }
    }

    function showDefaultMap() {
        try {
            console.log('Using default map view');
            map.setView([20.5937, 78.9629], 5);
            
            // Add a message
            L.marker([20.5937, 78.9629]).addTo(map)
                .bindPopup('Enable location access to see nearby safe places')
                .openPopup();
        } catch (error) {
            console.error('Error showing default map:', error);
        }
    }

    async function loadNearbyPlaces(lat, lng) {
        try {
            console.log('Loading nearby places...');
            
            // ‚úÖ ADD TIMEOUT TO PLACES REQUEST
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000);
            
            const response = await fetch(`/api/nearby-places?lat=${lat}&lng=${lng}&radius=5000`, {
                signal: controller.signal
            });

            clearTimeout(timeoutId);
            
            const data = await response.json();
            
            if (data.success && data.places && data.places.length > 0) {
                console.log(`Found ${data.places.length} nearby places`);
                
                data.places.forEach(place => {
                    try {
                        const markerColor = place.type === 'police' ? '#dc3545' : '#28a745';
                        const iconName = place.type === 'police' ? 'shield-alt' : 'hospital';
                        
                        const icon = L.divIcon({
                            className: 'safe-place-marker',
                            html: `<div style="background: ${markerColor}; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-size: 10px;">
                                    <i class="fas fa-${iconName}"></i>
                                  </div>`,
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        });
                        
                        const marker = L.marker([place.lat, place.lng], {icon: icon}).addTo(map);
                        
                        const popupContent = `
                            <div style="min-width: 200px;">
                                <h4 style="margin: 0 0 10px 0; color: ${markerColor};">
                                    <i class="fas fa-${iconName}"></i>
                                    ${place.name}
                                </h4>
                                <p style="margin: 5px 0; font-size: 12px; color: #666;">${place.address}</p>
                                <p style="margin: 5px 0; font-size: 12px;"><strong>Distance:</strong> ${place.distance.toFixed(2)} km</p>
                                <div style="margin-top: 10px;">
                                    <button onclick="window.open('https://www.google.com/maps/dir/?api=1&destination=${place.lat},${place.lng}', '_blank')" 
                                            style="background: #ff3b6c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 12px; margin-right: 5px;">
                                        <i class="fas fa-directions"></i> Directions
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        marker.bindPopup(popupContent);
                    } catch (markerError) {
                        console.error('Error adding marker:', markerError);
                    }
                });
                
                showNotification(`Found ${data.places.length} nearby safe places`, 'success');
            } else {
                console.log('No nearby places found');
                showNotification('No nearby safe places found', 'warning');
            }
        } catch (error) {
            console.error('Failed to load nearby places:', error);
            if (error.name === 'AbortError') {
                showNotification('Safe places loading timeout', 'error');
            } else {
                showNotification('Failed to load nearby places', 'error');
            }
        }
    }

    // ===== QUICK ACTIONS =====
    async function shareLiveLocation() {
        if (!navigator.geolocation) {
            showNotification('Geolocation not supported', 'error');
            return;
        }

        try {
            const position = await new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                    enableHighAccuracy: true,
                    timeout: 10000
                });
            });
            
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const userId = localStorage.getItem('userId');
            
            // ‚úÖ ADD TIMEOUT TO LOCATION SHARING
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000);
            
            const response = await fetch('/api/location', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({userId, lat, lng}),
                signal: controller.signal
            });

            clearTimeout(timeoutId);
            
            if (response.ok) {
                showNotification('üìç Location shared with emergency contacts', 'success');
            } else {
                showNotification('Failed to share location', 'error');
            }
        } catch (error) {
            if (error.name === 'AbortError') {
                showNotification('Location sharing timeout', 'error');
            } else {
                showNotification('Failed to get location: ' + error.message, 'error');
            }
        }
    }

    function triggerAlarm() {
        showNotification('üö® Loud alarm activated!', 'warning');
        
        // Visual alarm effect
        const alarmOverlay = document.createElement('div');
        alarmOverlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 59, 108, 0.8);
            z-index: 9999;
            animation: flash 0.5s infinite;
        `;
        
        document.body.appendChild(alarmOverlay);
        
        // Create alarm sound using Web Audio API
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 2);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 2);
            
        } catch (error) {
            console.log('Audio not supported');
        }
        
        setTimeout(() => {
            alarmOverlay.remove();
        }, 2000);
    }

    // ===== INITIALIZE DASHBOARD =====
    function initializeDashboard() {
        console.log('Initializing dashboard features...');
        
        // Load contacts
        loadContacts();
        
        // Initialize map
        initializeMap();
        
        // Show welcome notification
        setTimeout(() => {
            showNotification('Welcome to Guardian Angel! Your safety dashboard is ready.', 'success');
        }, 1000);
        
        console.log('‚úÖ All dashboard features initialized');
    }

    // Add CSS for flash animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    `;
    document.head.appendChild(style);
</script>
                      
    </body>
</html>
