<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guardian Angel - Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        
        :root {
            --primary: #ff3b6c;
            --secondary: #5e17eb;
            --dark: #1e1c2a;
            --light: #f8f9fa;
            --gray: #6c757d;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            color: var(--dark);
            min-height: 100vh;
        }
        
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, var(--dark) 0%, #2d2b3a 100%);
            color: white;
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            box-shadow: 5px 0 15px rgba(0,0,0,0.1);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }
        
        .logo i {
            color: var(--primary);
            font-size: 28px;
        }
        
        .logo h1 {
            font-size: 22px;
            font-weight: 700;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            gap: 15px;
            background: rgba(255,255,255,0.05);
            margin: 0 15px 20px;
            border-radius: 12px;
        }
        
        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 600;
            color: white;
        }
        
        .user-info h3 {
            font-size: 16px;
            margin-bottom: 5px;
            color: white;
        }
        
        .user-info p {
            font-size: 12px;
            color: var(--gray);
        }
        
        .nav-menu {
            flex: 1;
            padding: 10px 0;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 25px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .nav-item:hover, .nav-item.active {
            background: rgba(255,255,255,0.1);
            border-left: 4px solid var(--primary);
            color: white;
        }
        
        .nav-item i {
            width: 20px;
            text-align: center;
            font-size: 18px;
        }
        
        .logout-btn {
            margin: 20px;
            padding: 12px 20px;
            background: rgba(255,59,108,0.2);
            color: var(--primary);
            border: 1px solid var(--primary);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        
        .logout-btn:hover {
            background: var(--primary);
            color: white;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }
        
        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
        }
        
        .btn {
            padding: 12px 25px;
            border-radius: 50px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .btn-primary {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 4px 15px rgba(255, 59, 108, 0.3);
        }
        
        .btn-outline {
            background: transparent;
            color: var(--dark);
            border: 2px solid var(--dark);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.12);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }
        
        /* SOS Button */
        .sos-section {
            text-align: center;
            margin: 30px 0;
        }
        
        .sos-button {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 28px;
            font-weight: 700;
            box-shadow: 0 15px 40px rgba(255, 59, 108, 0.4);
            cursor: pointer;
            margin: 0 auto;
            transition: all 0.3s ease;
            position: relative;
            animation: pulse 2s infinite;
            border: none;
        }
        
        .sos-button:hover {
            transform: scale(1.05);
            box-shadow: 0 20px 50px rgba(255, 59, 108, 0.6);
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 59, 108, 0.7);
            }
            70% {
                box-shadow: 0 0 0 25px rgba(255, 59, 108, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 59, 108, 0);
            }
        }
        
        .sos-label {
            margin-top: 15px;
            color: var(--gray);
            font-size: 14px;
        }
        
        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .action-btn {
            background: var(--light);
            border-radius: 12px;
            padding: 20px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .action-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-color: var(--primary);
        }
        
        .action-btn i {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .action-btn div {
            font-size: 12px;
            font-weight: 500;
            color: var(--dark);
        }
        
        /* Contacts */
        .contact-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .contact-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            transition: background 0.3s ease;
        }
        
        .contact-item:hover {
            background: var(--light);
        }
        
        .contact-item:last-child {
            border-bottom: none;
        }
        
        .contact-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .contact-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--info);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
        }
        
        .contact-details h4 {
            font-size: 14px;
            margin-bottom: 2px;
        }
        
        .contact-details p {
            font-size: 12px;
            color: var(--gray);
        }
        
        .remove-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .add-contact-form {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .add-contact-form input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        
        /* Map Section */
        .map-section {
            margin-top: 30px;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            color: var(--primary);
        }
        
        #map {
            height: 400px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            border: 3px solid white;
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                padding: 15px;
            }
            
            .sos-button {
                width: 150px;
                height: 150px;
                font-size: 24px;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .header-actions {
                flex-direction: column;
                width: 100%;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <i class="fas fa-shield-alt"></i>
                <h1>Guardian Angel</h1>
            </div>
            
            <div class="user-profile">
                <div class="user-avatar" id="userAvatar">U</div>
                <div class="user-info">
                    <h3 id="userName">User</h3>
                    <p id="userPhone">+91 XXXXX XXXXX</p>
                </div>
            </div>
            
            <div class="nav-menu">
                <a href="#" class="nav-item active">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="nav-item">
                    <i class="fas fa-bell"></i>
                    <span>Emergency SOS</span>
                </a>
                <a href="#" class="nav-item">
                    <i class="fas fa-location-arrow"></i>
                    <span>Location Sharing</span>
                </a>
                <a href="#" class="nav-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>Safe Places</span>
                </a>
                <a href="#" class="nav-item">
                    <i class="fas fa-users"></i>
                    <span>Community Alerts</span>
                </a>
                <a href="#" class="nav-item">
                    <i class="fas fa-phone"></i>
                    <span>Fake Call</span>
                </a>
                <a href="#" class="nav-item">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </div>
            
            <button class="logout-btn" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </button>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h2 class="page-title">Safety Dashboard</h2>
                <div class="header-actions">
                    <button class="btn btn-outline">
                        <i class="fas fa-bell"></i>
                        Notifications
                    </button>
                    <button class="btn btn-primary" id="addContactMainBtn">
                        <i class="fas fa-plus"></i>
                        Add Emergency Contact
                    </button>
                </div>
            </div>
            
            <div class="dashboard-grid">
                <!-- SOS Card -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Emergency SOS</h3>
                        <div class="card-icon">
                            <i class="fas fa-bell"></i>
                        </div>
                    </div>
                    <div class="sos-section">
                        <button class="sos-button" id="sosBtn">
                            SOS
                        </button>
                        <div class="sos-label">
                            Press in case of emergency. Your location will be shared immediately.
                        </div>
                    </div>
                </div>
                
                <!-- Safety Status Card -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Safety Status</h3>
                        <div class="card-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                    </div>
                    <div style="text-align: center; margin: 20px 0;">
                        <div style="font-size: 48px; color: var(--success); margin: 15px 0;">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <h3 style="color: var(--success); margin-bottom: 10px;">All Systems Active</h3>
                        <p style="color: var(--gray);">Your safety features are enabled and working</p>
                    </div>
                    
                    <div class="quick-actions">
                        <div class="action-btn" id="shareLocationBtn">
                            <i class="fas fa-location-arrow"></i>
                            <div>Share Location</div>
                        </div>
                        <div class="action-btn" id="safePlacesBtn">
                            <i class="fas fa-map-marker-alt"></i>
                            <div>Safe Places</div>
                        </div>
                        <div class="action-btn" id="fakeCallBtn">
                            <i class="fas fa-phone"></i>
                            <div>Fake Call</div>
                        </div>
                        <div class="action-btn" id="soundAlarmBtn">
                            <i class="fas fa-bullhorn"></i>
                            <div>Sound Alarm</div>
                        </div>
                    </div>
                </div>
                
                <!-- Emergency Contacts Card -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Emergency Contacts</h3>
                        <div class="card-icon">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                    
                    <div class="contact-list" id="contactList">
                        <!-- Contacts will be loaded here -->
                    </div>
                    
                    <div class="add-contact-form">
                        <input type="text" id="newContact" placeholder="Enter phone number (+91xxxxxxxxxx)" maxlength="13">
                        <button class="btn btn-primary" id="addContactBtn">
                            <i class="fas fa-plus"></i>
                            Add
                        </button>
                    </div>
                </div>
                
                <!-- Recent Activity Card -->
                <!-- Recent Activity Card -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Recent Activity</h3>
                        <div class="card-icon">
                            <i class="fas fa-history"></i>
                        </div>
                    </div>
                    <div style="text-align: center; padding: 20px;">
                        <i class="fas fa-check-circle" style="font-size: 48px; color: var(--success); margin-bottom: 15px;"></i>
                        <h4 style="color: var(--success); margin-bottom: 10px;">No Recent Alerts</h4>
                        <p style="color: var(--gray); font-size: 14px;">Everything is safe and secure</p>
                    </div>
                </div>
            </div>
            
            <!-- Nearby Safe Places Section -->
            <div class="map-section">
                <h3 class="section-title">
                    <i class="fas fa-map-marked-alt"></i>
                    Nearby Safe Places
                </h3>
                <div id="map"></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // ------------------- Session Handling -------------------
            const userId = localStorage.getItem('userId');
            const userName = localStorage.getItem('userName');
            const userPhone = localStorage.getItem('userPhone');
            
            if(!userId) {
                alert('Login session expired');
                window.location.href = 'index.html';
                return;
            }

            // Update user info
            document.getElementById('userName').textContent = userName || 'User';
            document.getElementById('userPhone').textContent = userPhone || '+91 XXXXX XXXXX';
            document.getElementById('userAvatar').textContent = userName ? userName.charAt(0).toUpperCase() : 'U';


                        // Logout functionality
            document.getElementById('logoutBtn').addEventListener('click', () => {
                localStorage.clear();
                window.location.href = 'index.html';
            });

            // ------------------- Emergency Contacts -------------------
            const contactListEl = document.getElementById('contactList');
            let emergencyContacts = JSON.parse(localStorage.getItem('emergencyContacts')) || [];

            // Load contacts from server
            async function loadContactsFromServer() {
                try {
                    const response = await fetch(`/api/contacts/${userId}`);
                    const data = await response.json();
                    
                    if(data.success && data.contacts) {
                        emergencyContacts = data.contacts;
                        localStorage.setItem('emergencyContacts', JSON.stringify(emergencyContacts));
                        renderContacts();
                    }
                } catch(error) {
                    console.log('Using local contacts');
                }
            }

            function renderContacts(){
                contactListEl.innerHTML = '';
                
                if(emergencyContacts.length === 0) {
                    contactListEl.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--gray);">
                            <i class="fas fa-users" style="font-size: 48px; margin-bottom: 10px;"></i>
                            <p>No emergency contacts added</p>
                        </div>
                    `;
                    return;
                }

                emergencyContacts.forEach((contact, index) => {
                    const contactItem = document.createElement('div');
                    contactItem.className = 'contact-item';
                    
                    contactItem.innerHTML = `
                        <div class="contact-info">
                            <div class="contact-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="contact-details">
                                <h4>Contact ${index + 1}</h4>
                                <p>${contact}</p>
                            </div>
                        </div>
                        <button class="remove-btn" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    
                    contactListEl.appendChild(contactItem);
                });

                // Add event listeners to remove buttons
                document.querySelectorAll('.remove-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.currentTarget.getAttribute('data-index'));
                        emergencyContacts.splice(index, 1);
                        saveContacts();
                    });
                });
            }

            async function saveContacts(){
                localStorage.setItem('emergencyContacts', JSON.stringify(emergencyContacts));
                renderContacts();
                
                // Update server
                try {
                    await fetch('/api/contacts', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({userId, contacts: emergencyContacts})
                    });
                } catch(error) {
                    console.log('Failed to sync contacts with server');
                }
            }

            // Add contact functionality
            document.getElementById('addContactBtn').addEventListener('click', addContact);
            document.getElementById('addContactMainBtn').addEventListener('click', () => {
                document.getElementById('newContact').focus();
            });

            document.getElementById('newContact').addEventListener('keypress', (e) => {
                if(e.key === 'Enter') {
                    addContact();
                }
            });

            function addContact() {
                const number = document.getElementById('newContact').value.trim();
                
                // Basic phone validation
                const phoneRegex = /^(\+91[\-\s]?)?[0]?(91)?[6789]\d{9}$/;
                
                if(!number) {
                    alert('Please enter a phone number');
                    return;
                }
                
                if(!phoneRegex.test(number)) {
                    alert('Please enter a valid Indian phone number');
                    return;
                }
                
                if(emergencyContacts.includes(number)) {
                    alert('This number is already in your emergency contacts');
                    return;
                }
                
                if(emergencyContacts.length >= 5) {
                    alert('Maximum 5 emergency contacts allowed');
                    return;
                }

                emergencyContacts.push(number);
                document.getElementById('newContact').value = '';
                saveContacts();
                
                // Show success message
                showNotification('Contact added successfully!', 'success');
            }

            // Load initial contacts
            await loadContactsFromServer();
            renderContacts();

            // ------------------- SOS Functionality -------------------
            document.getElementById('sosBtn').addEventListener('click', triggerSOS);

            async function triggerSOS() {
                if(emergencyContacts.length === 0) {
                    alert('Please add emergency contacts first!');
                    document.getElementById('newContact').focus();
                    return;
                }

                // Animation
                const sosBtn = document.getElementById('sosBtn');
                sosBtn.style.transform = 'scale(1.1)';
                sosBtn.style.boxShadow = '0 0 40px rgba(255, 59, 108, 0.8)';
                
                setTimeout(() => {
                    sosBtn.style.transform = 'scale(1)';
                }, 300);

                if(!navigator.geolocation) {
                    alert('Geolocation not supported by your browser');
                    return;
                }

                // Get current location
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;

                    try {
                        const response = await fetch('/api/sos', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                userId, 
                                lat, 
                                lng, 
                                triggeredBy: 'button'
                            })
                        });
                        
                        const data = await response.json();
                        
                        if(data.success) {
                            showNotification('SOS sent successfully! Emergency contacts notified.', 'success');
                            
                            // Update recent activity
                            updateRecentActivity('SOS triggered', 'emergency');
                        } else {
                            showNotification('Failed to send SOS: ' + data.message, 'error');
                        }
                    } catch(error) {
                        showNotification('Network error. Please try again.', 'error');
                    }
                }, (error) => {
                    showNotification('Failed to get your location. Please enable location services.', 'error');
                });
            }

            // ------------------- Quick Actions -------------------
            document.getElementById('shareLocationBtn').addEventListener('click', () => {
                shareLiveLocation();
            });

            document.getElementById('safePlacesBtn').addEventListener('click', () => {
                document.getElementById('map').scrollIntoView({ behavior: 'smooth' });
            });

            document.getElementById('fakeCallBtn').addEventListener('click', triggerFakeCall);
            document.getElementById('soundAlarmBtn').addEventListener('click', triggerAlarm);

            // Share Live Location
            async function shareLiveLocation() {
                if(!navigator.geolocation) {
                    alert('Geolocation not supported');
                    return;
                }

                navigator.geolocation.getCurrentPosition(async (pos) => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    
                    try {
                        await fetch('/api/location', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({userId, lat, lng})
                        });
                        
                        showNotification('Location shared with emergency contacts', 'success');
                    } catch(error) {
                        showNotification('Failed to share location', 'error');
                    }
                });
            }

            // Fake Call Feature
            function triggerFakeCall() {
                // Create fake call overlay
                const fakeCallHTML = `
                    <div id="fakeCallOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index:10000; color:white; display:flex; flex-direction:column; justify-content:center; align-items:center; font-family: Arial, sans-serif;">
                        <div style="text-align:center;">
                            <div style="font-size: 48px; margin-bottom: 20px;">üìû</div>
                            <h2 style="margin-bottom: 5px;">Incoming Call</h2>
                            <h3 style="margin-bottom: 5px; font-size: 24px;">Mom</h3>
                            <p style="margin-bottom: 30px; opacity: 0.8;">+91 ‚óè‚óè‚óè‚óè‚óè ‚óè‚óè‚óè‚óè‚óè</p>
                            <div style="display: flex; gap: 20px;">
                                <button onclick="acceptFakeCall()" style="background:#4CAF50; color:white; width: 60px; height: 60px; border:none; border-radius:50%; font-size: 24px; cursor:pointer;">
                                    üìû
                                </button>
                                <button onclick="rejectFakeCall()" style="background:#f44336; color:white; width: 60px; height: 60px; border:none; border-radius:50%; font-size: 24px; cursor:pointer;">
                                    üìµ
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', fakeCallHTML);
                
                // Add global functions for the buttons
                window.acceptFakeCall = function() {
                    document.getElementById('fakeCallOverlay').innerHTML = `
                        <div style="text-align:center;">
                            <div style="font-size: 48px; margin-bottom: 20px;">üìû</div>
                            <h2>Call Connected</h2>
                            <p style="margin: 20px 0;">Pretend conversation in progress...</p>
                            <button onclick="endFakeCall()" style="background:#f44336; color:white; padding: 15px 30px; border:none; border-radius:25px; cursor:pointer; font-size: 16px;">
                                End Call
                            </button>
                        </div>
                    `;
                };
                
                window.rejectFakeCall = function() {
                    document.getElementById('fakeCallOverlay').remove();
                    showNotification('Call rejected', 'info');
                };
                
                window.endFakeCall = function() {
                    document.getElementById('fakeCallOverlay').remove();
                    showNotification('Call ended', 'info');
                };
            }

            // Sound Alarm
            function triggerAlarm() {
                showNotification('Loud alarm activated!', 'warning');
                
                // Create alarm sound using Web Audio API
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 2);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 2);
                    
                } catch(error) {
                    console.log('Audio not supported');
                }
            }

            // ------------------- Nearby Safe Places Map -------------------
            let map;
            
            function initializeMap() {
                map = L.map('map').setView([20.5937, 78.9629], 5);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors',
                    maxZoom: 18
                }).addTo(map);

                // Get user location and show nearby places
                if(navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(showUserLocation, showDefaultMap);
                } else {
                    showDefaultMap();
                }
            }

            function showUserLocation(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                map.setView([lat, lng], 14);
                
                // Add user marker
                const userMarker = L.marker([lat, lng]).addTo(map);
                userMarker.bindPopup(`
                    <div style="text-align: center;">
                        <h4>Your Location</h4>
                        <p>You are here</p>
                    </div>
                `).openPopup();
                
                // Add circle around user location
                L.circle([lat, lng], {
                    color: '#ff3b6c',
                    fillColor: '#ff3b6c',
                    fillOpacity: 0.1,
                    radius: 1000
                }).addTo(map);
                
                // Load nearby safe places
                loadNearbyPlaces(lat, lng);
            }

            function showDefaultMap() {
                // Default to India view if location not available
                map.setView([20.5937, 78.9629], 5);
            }

            async function loadNearbyPlaces(lat, lng) {
                try {
                    const response = await fetch(`/api/nearby-places?lat=${lat}&lng=${lng}&radius=5000`);
                    const data = await response.json();
                    
                    if(data.success && data.places) {
                        data.places.forEach(place => {
                            const markerColor = place.type === 'police' ? '#dc3545' : '#28a745';
                            const icon = L.divIcon({
                                className: 'custom-marker',
                                html: `<div style="background: ${markerColor}; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>`,
                                iconSize: [20, 20],
                                iconAnchor: [10, 10]
                            });
                            
                            const marker = L.marker([place.lat, place.lng], {icon: icon}).addTo(map);
                            
                            const popupContent = `
                                <div style="min-width: 200px;">
                                    <h4 style="margin: 0 0 10px 0; color: ${markerColor};">
                                        <i class="fas fa-${place.type === 'police' ? 'shield-alt' : 'hospital'}"></i>
                                        ${place.name}
                                    </h4>
                                    <p style="margin: 5px 0; font-size: 12px; color: #666;">${place.address}</p>
                                    <p style="margin: 5px 0; font-size: 12px;"><strong>Distance:</strong> ${place.distance.toFixed(2)} km</p>
                                    <div style="margin-top: 10px;">
                                        <button onclick="window.open('https://www.google.com/maps/dir/?api=1&destination=${place.lat},${place.lng}', '_blank')" 
                                                style="background: #ff3b6c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 12px; margin-right: 5px;">
                                            <i class="fas fa-directions"></i> Directions
                                        </button>
                                    </div>
                                </div>
                            `;
                            
                            marker.bindPopup(popupContent);
                        });
                    }
                } catch(error) {
                    console.log('Failed to load nearby places:', error);
                }
            }

            // ------------------- Utility Functions -------------------
            function showNotification(message, type = 'info') {
                // Create notification element
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 20px;
                    background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : type === 'warning' ? '#ffc107' : '#17a2b8'};
                    color: white;
                    border-radius: 8px;
                    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                    z-index: 10001;
                    max-width: 300px;
                    animation: slideIn 0.3s ease;
                `;
                
                notification.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : type === 'warning' ? 'bell' : 'info-circle'}"></i>
                        <span>${message}</span>
                    </div>
                `;
            document.body.appendChild(notification);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => {
                        if(notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            }

            function updateRecentActivity(message, type) {
                // This would update the recent activity card
                console.log('Activity:', message, type);
            }

            // Add CSS animations
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);

            // ------------------- Volume Button SOS -------------------
            let volumePressCount = 0;
            let lastVolumePress = 0;

            document.addEventListener('keydown', (e) => {
                if (e.code === 'VolumeUp' || e.code === 'VolumeDown') {
                    const now = Date.now();
                    
                    if (now - lastVolumePress > 2000) {
                        volumePressCount = 0;
                    }
                    
                    volumePressCount++;
                    lastVolumePress = now;
                    
                    if (volumePressCount >= 3) {
                        volumePressCount = 0;
                        triggerVolumeSOS();
                    }
                }
            });

            async function triggerVolumeSOS() {
                if(emergencyContacts.length === 0) return;
                
                if(!navigator.geolocation) return;

                navigator.geolocation.getCurrentPosition(async (pos) => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;

                    try {
                        await fetch('/api/sos/volume', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({userId, lat, lng})
                        });
                        
                        showNotification('Volume SOS triggered!', 'warning');
                    } catch(error) {
                        console.log('Volume SOS failed');
                    }
                });
            }

            // Initialize the application
            initializeMap();
        });
    </script>
</body>
</html>
