<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency SOS - Guardian Angel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        
        :root {
            --primary: #ff3b6c;
            --secondary: #5e17eb;
            --dark: #1e1c2a;
            --light: #f8f9fa;
            --gray: #6c757d;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            color: var(--dark);
            min-height: 100vh;
        }
        
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar - Same as Other Pages */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, var(--dark) 0%, #2d2b3a 100%);
            color: white;
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            box-shadow: 5px 0 15px rgba(0,0,0,0.1);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }
        
        .logo i {
            color: var(--primary);
            font-size: 28px;
        }
        
        .logo h1 {
            font-size: 22px;
            font-weight: 700;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            gap: 15px;
            background: rgba(255,255,255,0.05);
            margin: 0 15px 20px;
            border-radius: 12px;
        }
        
        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 600;
            color: white;
        }
        
        .user-info h3 {
            font-size: 16px;
            margin-bottom: 5px;
            color: white;
        }
        
        .user-info p {
            font-size: 12px;
            color: var(--gray);
        }
        
        .nav-menu {
            flex: 1;
            padding: 10px 0;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 25px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            cursor: pointer;
        }
        
        .nav-item:hover, .nav-item.active {
            background: rgba(255,255,255,0.1);
            border-left: 4px solid var(--primary);
            color: white;
        }
        
        .nav-item i {
            width: 20px;
            text-align: center;
            font-size: 18px;
        }
        
        .logout-btn {
            margin: 20px;
            padding: 12px 20px;
            background: rgba(255,59,108,0.2);
            color: var(--primary);
            border: 1px solid var(--primary);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        
        .logout-btn:hover {
            background: var(--primary);
            color: white;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }
        
        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
        }
        
        .btn {
            padding: 12px 25px;
            border-radius: 50px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .btn-primary {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 4px 15px rgba(255, 59, 108, 0.3);
        }
        
        .btn-outline {
            background: transparent;
            color: var(--dark);
            border: 2px solid var(--dark);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        /* SOS Content */
        .sos-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .sos-button {
            width: 250px;
            height: 250px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--danger), #ff6b6b);
            border: none;
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 15px 40px rgba(255, 0, 0, 0.4);
            transition: all 0.3s ease;
            margin: 0 auto 40px;
            position: relative;
            overflow: hidden;
        }
        
        .sos-button:hover {
            transform: scale(1.05);
            box-shadow: 0 20px 50px rgba(255, 0, 0, 0.6);
        }
        
        .sos-button:active {
            transform: scale(0.95);
        }
        
        .sos-button.pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { 
                box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7);
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            70% { 
                box-shadow: 0 0 0 25px rgba(255, 0, 0, 0);
            }
            100% { 
                box-shadow: 0 0 0 0 rgba(255, 0, 0, 0);
                transform: scale(1);
            }
        }
        
        .sos-icon {
            font-size: 60px;
            margin-bottom: 15px;
        }
        
        .sos-instructions {
            background: var(--light);
            padding: 25px;
            border-radius: 15px;
            margin: 30px 0;
            text-align: left;
        }
        
        .instructions-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--dark);
        }
        
        .instruction-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 12px;
            padding: 10px;
            background: white;
            border-radius: 10px;
        }
        
        .instruction-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .status-panel {
            background: var(--light);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .status-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        
        .status-label {
            font-size: 14px;
            color: var(--gray);
            margin-bottom: 8px;
        }
        
        .status-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .status-value.success {
            color: var(--success);
        }
        
        .status-value.error {
            color: var(--danger);
        }
        
        .status-value.pending {
            color: var(--warning);
        }
        
        .contacts-panel {
            background: var(--light);
            padding: 25px;
            border-radius: 15px;
        }
        
        .contacts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .contacts-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .contact-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .contact-info {
            display: flex;
            flex-direction: column;
        }
        
        .contact-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .contact-number {
            color: var(--gray);
            font-size: 14px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            z-index: 10000;
            max-width: 300px;
            animation: slideIn 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .notification.success {
            background: var(--success);
        }
        
        .notification.error {
            background: var(--danger);
        }
        
        .notification.info {
            background: var(--info);
        }
        
        .notification.warning {
            background: var(--warning);
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                padding: 15px;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .header-actions {
                flex-direction: column;
                width: 100%;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .sos-button {
                width: 200px;
                height: 200px;
            }
            
            .status-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar - Same as Dashboard -->
        <div class="sidebar">
            <div class="logo">
                <i class="fas fa-shield-alt"></i>
                <h1>Guardian Angel</h1>
            </div>
            
            <div class="user-profile">
                <div class="user-avatar" id="userAvatar">U</div>
                <div class="user-info">
                    <h3 id="userName">User</h3>
                    <p id="userPhone">+91 XXXXX XXXXX</p>
                </div>
            </div>
            
            <div class="nav-menu">
                <a href="dashboard.html" class="nav-item">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="nav-item active">
                    <i class="fas fa-bell"></i>
                    <span>Emergency SOS</span>
                </a>
                <a href="location.html" class="nav-item">
                    <i class="fas fa-location-arrow"></i>
                    <span>Location Sharing</span>
                </a>
                <a href="safe-places.html" class="nav-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>Safe Places</span>
                </a>
                <a href="community.html" class="nav-item">
                    <i class="fas fa-users"></i>
                    <span>Community Alerts</span>
                </a>
                <a href="fake-call.html" class="nav-item">
                    <i class="fas fa-phone"></i>
                    <span>Fake Call</span>
                </a>
                <a href="settings.html" class="nav-item">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </div>
            
            <button class="logout-btn" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </button>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h2 class="page-title">Emergency SOS</h2>
                <div class="header-actions">
                    <button class="btn btn-outline" id="refreshBtn">
                        <i class="fas fa-sync-alt"></i>
                        Refresh Status
                    </button>
                    <button class="btn btn-primary" id="testSMSBtn">
                        <i class="fas fa-sms"></i>
                        Test SMS
                    </button>
                </div>
            </div>
            
            <div class="sos-container">
                <!-- SOS Button -->
                <button class="sos-button pulse" id="sosButton">
                    <div class="sos-icon">
                        <i class="fas fa-bell"></i>
                    </div>
                    <div>SOS</div>
                    <div>EMERGENCY</div>
                </button>
                
                <!-- Instructions -->
                <div class="sos-instructions">
                    <h3 class="instructions-title">How to Use SOS</h3>
                    <div class="instruction-item">
                        <div class="instruction-icon">1</div>
                        <div>
                            <strong>Tap SOS Button</strong><br>
                            Click the red SOS button above to immediately send emergency alerts
                        </div>
                    </div>
                    <div class="instruction-item">
                        <div class="instruction-icon">2</div>
                        <div>
                            <strong>Volume Button Shortcut</strong><br>
                            Press both Volume Up + Volume Down buttons together 3 times quickly
                        </div>
                    </div>
                    <div class="instruction-item">
                        <div class="instruction-icon">3</div>
                        <div>
                            <strong>Automatic Features</strong><br>
                            Sends your location, emergency message to all contacts automatically
                        </div>
                    </div>
                </div>
                
                <!-- Status Panel -->
                <div class="status-panel">
                    <h3>System Status</h3>
                    <div class="status-grid">
                        <div class="status-item">
                            <div class="status-label">Location Access</div>
                            <div class="status-value" id="locationStatus">Checking...</div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">SMS Service</div>
                            <div class="status-value" id="smsStatus">Ready</div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">Emergency Contacts</div>
                            <div class="status-value" id="contactsStatus">Loading...</div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">Last SOS</div>
                            <div class="status-value" id="lastSOSStatus">Never</div>
                        </div>
                    </div>
                </div>
                
                <!-- Emergency Contacts -->
                <div class="contacts-panel">
                    <div class="contacts-header">
                        <h3>Emergency Contacts</h3>
                        <span id="contactsCount">0 contacts</span>
                    </div>
                    <div class="contacts-list" id="contactsList">
                        <!-- Contacts will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== GLOBAL VARIABLES =====
        let currentUser = null;
        let emergencyContacts = [];
        let volumePressCount = 0;
        let lastVolumePress = 0;
        let volumeUpPressed = false;
        let volumeDownPressed = false;

        // ===== SESSION MANAGEMENT =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸš¨ SOS Page Loading...');
            
            // Check if user is logged in
            const userId = localStorage.getItem('userId');
            const userName = localStorage.getItem('userName');
            const userPhone = localStorage.getItem('userPhone');
            
            if (!userId) {
                showNotification('Please login first', 'error');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
                return;
            }

            // Set current user
            currentUser = {
                userId: userId,
                name: userName,
                phone: userPhone
            };

            // Update user info
            document.getElementById('userName').textContent = userName || 'User';
            document.getElementById('userPhone').textContent = userPhone || '+91 XXXXX XXXXX';
            document.getElementById('userAvatar').textContent = (userName || 'U').charAt(0).toUpperCase();

            // Initialize SOS page
            initializeSOSPage();

            // Event Listeners
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('refreshBtn').addEventListener('click', initializeSOSPage);
            document.getElementById('testSMSBtn').addEventListener('click', testSMS);
        });

        // ===== INITIALIZE SOS PAGE =====
        function initializeSOSPage() {
            console.log('Initializing SOS page...');
            
            // Load emergency contacts
            loadEmergencyContacts();
            
            // Check location permission
            checkLocationPermission();
            
            // Load SOS history
            loadSOSHistory();
            
            // Set up event listeners
            setupEventListeners();
            
            // Set up volume button detection
            setupVolumeButtonDetection();
            
            showNotification('SOS System Ready!', 'success');
        }

        // ===== EVENT LISTENERS =====
        function setupEventListeners() {
            // SOS Button
            const sosButton = document.getElementById('sosButton');
            sosButton.addEventListener('click', triggerSOS);
            
            // Keyboard shortcut for SOS (Spacebar)
            document.addEventListener('keydown', function(event) {
                if (event.code === 'Space' && event.target.tagName !== 'INPUT') {
                    event.preventDefault();
                    triggerSOS();
                }
            });
        }

        // ===== VOLUME BUTTON DETECTION =====
        function setupVolumeButtonDetection() {
            document.addEventListener('keydown', function(e) {
                if (e.code === 'VolumeUp') {
                    volumeUpPressed = true;
                    checkVolumeCombo();
                }
                if (e.code === 'VolumeDown') {
                    volumeDownPressed = true;
                    checkVolumeCombo();
                }
            });

            document.addEventListener('keyup', function(e) {
                if (e.code === 'VolumeUp') {
                    volumeUpPressed = false;
                }
                if (e.code === 'VolumeDown') {
                    volumeDownPressed = false;
                }
            });
        }

        function checkVolumeCombo() {
            if (volumeUpPressed && volumeDownPressed) {
                const now = Date.now();
                
                if (now - lastVolumePress > 2000) {
                    volumePressCount = 0;
                }
                
                volumePressCount++;
                lastVolumePress = now;
                
                if (volumePressCount >= 3) {
                    volumePressCount = 0;
                    showNotification('Volume Button SOS Triggered!', 'warning');
                    triggerSOS();
                }
            }
        }

        // ===== LOAD EMERGENCY CONTACTS =====
        function loadEmergencyContacts() {
            try {
                // Load from localStorage first
                emergencyContacts = JSON.parse(localStorage.getItem('emergencyContacts')) || [];
                updateContactsUI();
                
                // Simulate API call to MongoDB
                setTimeout(() => {
                    // This would be your actual API call to get contacts from MongoDB
                    // fetch(`/api/contacts/${currentUser.userId}`)
                    // .then(response => response.json())
                    // .then(data => {
                    //     if (data.success && data.contacts) {
                    //         emergencyContacts = data.contacts;
                    //         localStorage.setItem('emergencyContacts', JSON.stringify(emergencyContacts));
                    //         updateContactsUI();
                    //     }
                    // })
                    
                    // For demo, using localStorage contacts
                    updateContactsUI();
                }, 1000);
                
            } catch (error) {
                console.error('Error loading contacts:', error);
                emergencyContacts = [];
                updateContactsUI();
            }
        }

        // ===== UPDATE CONTACTS UI =====
        function updateContactsUI() {
            const contactsList = document.getElementById('contactsList');
            const contactsCount = document.getElementById('contactsCount');
            const contactsStatus = document.getElementById('contactsStatus');

            if (emergencyContacts.length === 0) {
                contactsList.innerHTML = `
                    <div style="text-align: center; padding: 20px; opacity: 0.7;">
                        <p>No emergency contacts set</p>
                        <p style="font-size: 0.8rem; margin-top: 5px;">Add contacts in Settings</p>
                    </div>
                `;
                contactsCount.textContent = '0 contacts';
                contactsStatus.textContent = 'No contacts';
                contactsStatus.className = 'status-value error';
            } else {
                contactsList.innerHTML = emergencyContacts.map(contact => `
                    <div class="contact-item">
                        <div class="contact-info">
                            <div class="contact-name">${contact.name}</div>
                            <div class="contact-number">${contact.number}</div>
                        </div>
                        <span class="status-value success">âœ… Ready</span>
                    </div>
                `).join('');
                contactsCount.textContent = `${emergencyContacts.length} contact${emergencyContacts.length > 1 ? 's' : ''}`;
                contactsStatus.textContent = `${emergencyContacts.length} contacts`;
                contactsStatus.className = 'status-value success';
            }
        }

        // ===== CHECK LOCATION PERMISSION =====
        async function checkLocationPermission() {
            const locationStatus = document.getElementById('locationStatus');
            
            if (!navigator.geolocation) {
                locationStatus.textContent = 'Not supported';
                locationStatus.className = 'status-value error';
                return;
            }

            try {
                await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        timeout: 5000,
                        maximumAge: 0
                    });
                });
                
                locationStatus.textContent = 'Granted';
                locationStatus.className = 'status-value success';
            } catch (error) {
                locationStatus.textContent = 'Denied';
                locationStatus.className = 'status-value error';
                showNotification('Location access is required for SOS', 'error');
            }
        }

        // ===== GET CURRENT LOCATION =====
        function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation not supported'));
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        });
                    },
                    (error) => {
                        let errorMessage = 'Location access failed';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = 'Location permission denied';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = 'Location unavailable';
                                break;
                            case error.TIMEOUT:
                                errorMessage = 'Location request timeout';
                                break;
                        }
                        reject(new Error(errorMessage));
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            });
                           }
        / ===== MAIN SOS FUNCTION =====
        async function triggerSOS() {
            if (!currentUser) {
                showNotification('Please login first', 'error');
                return;
            }

            if (emergencyContacts.length === 0) {
                showNotification('No emergency contacts set. Please add contacts in Settings.', 'error');
                return;
            }

            const sosButton = document.getElementById('sosButton');
            const smsStatus = document.getElementById('smsStatus');
            const originalHTML = sosButton.innerHTML;
            
            try {
                // Show loading state
                sosButton.disabled = true;
                sosButton.innerHTML = '<div class="loading-spinner"></div><div>PROCESSING...</div>';
                sosButton.style.animation = 'none';
                smsStatus.innerHTML = '<span class="loading-spinner"></span> Sending Alerts...';
                smsStatus.className = 'status-value pending';

                // Get current location
                const location = await getCurrentLocation();
                console.log('ðŸ“ Location obtained:', location);
                
                // Simulate sending SMS to emergency contacts
                const smsPromises = emergencyContacts.map(contact => {
                    return sendSMS(contact.number, location);
                });

                // Wait for all SMS to be sent
                const results = await Promise.allSettled(smsPromises);
                const successfulSends = results.filter(result => result.status === 'fulfilled').length;
                
                // Update UI based on results
                if (successfulSends > 0) {
                    showNotification(`ðŸš¨ Emergency alerts sent to ${successfulSends} contacts!`, 'success');
                    smsStatus.textContent = `Sent to ${successfulSends} contacts`;
                    smsStatus.className = 'status-value success';
                    
                    // Update last SOS time
                    updateLastSOSStatus();
                    
                    // Emergency visual effects
                    document.body.style.background = 'linear-gradient(135deg, #ff0000 0%, #8B0000 100%)';
                    setTimeout(() => {
                        document.body.style.background = 'linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%)';
                    }, 3000);
                    
                } else {
                    showNotification('âŒ Failed to send emergency alerts', 'error');
                    smsStatus.textContent = 'Failed';
                    smsStatus.className = 'status-value error';
                }

            } catch (error) {
                console.error('SOS Error:', error);
                showNotification(`âŒ SOS failed: ${error.message}`, 'error');
                smsStatus.textContent = 'Failed';
                smsStatus.className = 'status-value error';
            } finally {
                // Reset button state
                setTimeout(() => {
                    sosButton.disabled = false;
                    sosButton.innerHTML = originalHTML;
                    sosButton.style.animation = 'pulse 2s infinite';
                    
                    // Reset SMS status after 5 seconds
                    setTimeout(() => {
                        smsStatus.textContent = 'Ready';
                        smsStatus.className = 'status-value';
                    }, 5000);
                }, 2000);
            }
        }

        // ===== SEND SMS FUNCTION =====
        async function sendSMS(phoneNumber, location) {
            // This would be your actual SMS API call
            // For demo, we'll simulate the API call
            
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    // Simulate API call to Twilio or other SMS service
                    // const response = await fetch('/api/send-sms', {
                    //     method: 'POST',
                    //     headers: {
                    //         'Content-Type': 'application/json',
                    //     },
                    //     body: JSON.stringify({
                    //         to: phoneNumber,
                    //         message: `ðŸš¨ EMERGENCY ALERT! ${currentUser.name} needs help! Location: https://maps.google.com/?q=${location.lat},${location.lng}`,
                    //         location: location
                    //     })
                    // });
                    
                    // Simulate 90% success rate for demo
                    if (Math.random() > 0.1) {
                        resolve({ success: true, to: phoneNumber });
                    } else {
                        reject(new Error('SMS failed'));
                    }
                }, 1000 + Math.random() * 2000); // Random delay between 1-3 seconds
            });
        }

        // ===== TEST SMS FUNCTION =====
        async function testSMS() {
            if (emergencyContacts.length === 0) {
                showNotification('No emergency contacts to test with', 'error');
                return;
            }

            showNotification('Sending test SMS...', 'info');
            
            try {
                const location = await getCurrentLocation();
                const testContact = emergencyContacts[0]; // Test with first contact
                
                await sendSMS(testContact.number, location);
                showNotification(`Test SMS sent to ${testContact.name}`, 'success');
            } catch (error) {
                showNotification('Test SMS failed', 'error');
            }
        }

        // ===== LOAD SOS HISTORY =====
        async function loadSOSHistory() {
            if (!currentUser) return;
            
            try {
                // Simulate API call to get SOS history
                // const response = await fetch(`/api/sos-history/${currentUser.userId}`);
                // const data = await response.json();
                
                // For demo, use localStorage
                const sosHistory = JSON.parse(localStorage.getItem('sosHistory')) || [];
                
                if (sosHistory.length > 0) {
                    const lastSOS = sosHistory[sosHistory.length - 1];
                    const lastSOSStatus = document.getElementById('lastSOSStatus');
                    const timeAgo = getTimeAgo(new Date(lastSOS.timestamp));
                    lastSOSStatus.textContent = timeAgo;
                    lastSOSStatus.className = 'status-value success';
                }
            } catch (error) {
                console.error('Error loading SOS history:', error);
            }
        }

        // ===== UPDATE LAST SOS STATUS =====
        function updateLastSOSStatus() {
            const lastSOSStatus = document.getElementById('lastSOSStatus');
            lastSOSStatus.textContent = 'Just now';
            lastSOSStatus.className = 'status-value success';
            
            // Save to localStorage for demo
            const sosHistory = JSON.parse(localStorage.getItem('sosHistory')) || [];
            sosHistory.push({
                timestamp: new Date().toISOString(),
                contactsNotified: emergencyContacts.length,
                location: { lat: 0, lng: 0 } // Would be actual location in real app
            });
            localStorage.setItem('sosHistory', JSON.stringify(sosHistory));
        }

        // ===== UTILITY FUNCTIONS =====
        function getTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            return `${days}d ago`;
        }

        // ===== LOGOUT FUNCTION =====
        function logout() {
            localStorage.clear();
            showNotification('Logged out successfully', 'success');
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 1000);
        }

        // ===== NOTIFICATION SYSTEM =====
        function showNotification(message, type = 'info') {
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notif => {
                notif.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notif.parentNode) {
                        notif.parentNode.removeChild(notif);
                    }
                }, 300);
            });

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 5000);
        }
    </script>
</body>
</html>
        
