<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safe Places - Guardian Angel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        
        :root {
            --primary: #ff3b6c;
            --secondary: #5e17eb;
            --dark: #1e1c2a;
            --light: #f8f9fa;
            --gray: #6c757d;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            color: var(--dark);
            min-height: 100vh;
        }
        
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar - Same as Dashboard */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, var(--dark) 0%, #2d2b3a 100%);
            color: white;
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            box-shadow: 5px 0 15px rgba(0,0,0,0.1);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }
        
        .logo i {
            color: var(--primary);
            font-size: 28px;
        }
        
        .logo h1 {
            font-size: 22px;
            font-weight: 700;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            gap: 15px;
            background: rgba(255,255,255,0.05);
            margin: 0 15px 20px;
            border-radius: 12px;
        }
        
        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 600;
            color: white;
        }
        
        .user-info h3 {
            font-size: 16px;
            margin-bottom: 5px;
            color: white;
        }
        
        .user-info p {
            font-size: 12px;
            color: var(--gray);
        }
        
        .nav-menu {
            flex: 1;
            padding: 10px 0;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 25px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            cursor: pointer;
        }
        
        .nav-item:hover, .nav-item.active {
            background: rgba(255,255,255,0.1);
            border-left: 4px solid var(--primary);
            color: white;
        }
        
        .nav-item i {
            width: 20px;
            text-align: center;
            font-size: 18px;
        }
        
        .logout-btn {
            margin: 20px;
            padding: 12px 20px;
            background: rgba(255,59,108,0.2);
            color: var(--primary);
            border: 1px solid var(--primary);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        
        .logout-btn:hover {
            background: var(--primary);
            color: white;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }
        
        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
        }
        
        .btn {
            padding: 12px 25px;
            border-radius: 50px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .btn-primary {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 4px 15px rgba(255, 59, 108, 0.3);
        }
        
        .btn-outline {
            background: transparent;
            color: var(--dark);
            border: 2px solid var(--dark);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        /* Safe Places Content */
        .safe-places-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        
        .location-section {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--light);
            border-radius: 15px;
        }
        
        .location-icon {
            font-size: 48px;
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        .current-location {
            font-size: 16px;
            color: var(--gray);
            margin-top: 10px;
        }
        
        .places-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .place-card {
            background: var(--light);
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
            border-left: 4px solid var(--primary);
        }
        
        .place-card.police {
            border-left-color: #dc3545;
        }
        
        .place-card.hospital {
            border-left-color: #28a745;
        }
        
        .place-card.clinic {
            border-left-color: #17a2b8;
        }
        
        .place-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .place-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .place-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }
        
        .place-icon.police {
            background: #dc3545;
        }
        
        .place-icon.hospital {
            background: #28a745;
        }
        
        .place-icon.clinic {
            background: #17a2b8;
        }
        
        .place-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .place-details {
            margin: 15px 0;
        }
        
        .place-address {
            color: var(--gray);
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .place-distance {
            color: var(--primary);
            font-weight: 600;
            font-size: 14px;
        }
        
        .place-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .action-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
        }
        
        .action-btn.directions {
            background: var(--primary);
            color: white;
        }
        
        .action-btn.call {
            background: var(--success);
            color: white;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
        }
        
        .loading-spinner {
            text-align: center;
            padding: 40px;
            color: var(--gray);
        }
        
        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,59,108,0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            z-index: 10000;
            max-width: 300px;
            animation: slideIn 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .notification.success {
            background: var(--success);
        }
        
        .notification.error {
            background: var(--danger);
        }
        
        .notification.info {
            background: var(--info);
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                padding: 15px;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .header-actions {
                flex-direction: column;
                width: 100%;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .places-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar - Same as Dashboard -->
        <div class="sidebar">
            <div class="logo">
                <i class="fas fa-shield-alt"></i>
                <h1>Guardian Angel</h1>
            </div>
            
            <div class="user-profile">
                <div class="user-avatar" id="userAvatar">U</div>
                <div class="user-info">
                    <h3 id="userName">User</h3>
                    <p id="userPhone">+91 XXXXX XXXXX</p>
                </div>
            </div>
            
            <div class="nav-menu">
                <a href="dashboard.html" class="nav-item">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a href="sos.html" class="nav-item">
                    <i class="fas fa-bell"></i>
                    <span>Emergency SOS</span>
                </a>
                <a href="location.html" class="nav-item">
                    <i class="fas fa-location-arrow"></i>
                    <span>Location Sharing</span>
                </a>
                <a href="#" class="nav-item active">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>Safe Places</span>
                </a>
                <a href="community.html" class="nav-item">
                    <i class="fas fa-users"></i>
                    <span>Community Alerts</span>
                </a>
                <a href="fake-call.html" class="nav-item">
                    <i class="fas fa-phone"></i>
                    <span>Fake Call</span>
                </a>
                <a href="settings.html" class="nav-item">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </div>
            
            <button class="logout-btn" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </button>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h2 class="page-title">Nearby Safe Places</h2>
                <div class="header-actions">
                    <button class="btn btn-outline" id="refreshBtn">
                        <i class="fas fa-sync-alt"></i>
                        Refresh
                    </button>
                    <button class="btn btn-primary" id="getLocationBtn">
                        <i class="fas fa-location-arrow"></i>
                        Get My Location
                    </button>
                </div>
            </div>
            
            <div class="safe-places-container">
                <div class="location-section">
                    <div class="location-icon">
                        <i class="fas fa-map-marker-alt"></i>
                    </div>
                    <h3>Your Current Location</h3>
                    <p class="current-location" id="currentLocation">Getting your location...</p>
                </div>
                
                <div id="placesList">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <p>Finding nearby safe places...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== SESSION MANAGEMENT =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìç Safe Places Page Loading...');
            
            // Check if user is logged in
            const userId = localStorage.getItem('userId');
            const userName = localStorage.getItem('userName');
            const userPhone = localStorage.getItem('userPhone');
            
            if (!userId) {
                showNotification('Please login first', 'error');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
                return;
            }

            // Update user info in sidebar
            document.getElementById('userName').textContent = userName || 'User';
            document.getElementById('userPhone').textContent = userPhone || '+91 XXXXX XXXXX';
            document.getElementById('userAvatar').textContent = userName ? userName.charAt(0).toUpperCase() : 'U';

            // Initialize safe places
            initializeSafePlaces();

            // ===== LOGOUT FUNCTION =====
            document.getElementById('logoutBtn').addEventListener('click', function() {
                localStorage.clear();
                showNotification('Logged out successfully', 'success');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
            });

            // ===== REFRESH BUTTON =====
            document.getElementById('refreshBtn').addEventListener('click', function() {
                initializeSafePlaces();
            });

            // ===== GET LOCATION BUTTON =====
            document.getElementById('getLocationBtn').addEventListener('click', function() {
                getCurrentLocation();
            });
        });

        // ===== NOTIFICATION SYSTEM =====
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }

        // ===== LOCATION FUNCTIONS =====
        function getCurrentLocation() {
            if (!navigator.geolocation) {
                showNotification('Geolocation not supported by your browser', 'error');
                return;
            }

            showNotification('Getting your location...', 'info');
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // Update location display
                    document.getElementById('currentLocation').innerHTML = `
                        <strong>Latitude:</strong> ${lat.toFixed(6)}<br>
                        <strong>Longitude:</strong> ${lng.toFixed(6)}
                    `;
                    
                    // Load nearby places
                    loadNearbyPlaces(lat, lng);
                    
                    showNotification('Location found! Loading safe places...', 'success');
                },
                function(error) {
                    let errorMessage = 'Location access failed';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'Location permission denied. Please enable location access.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'Location information unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'Location request timeout.';
                            break;
                    }
                    showNotification(errorMessage, 'error');
                    document.getElementById('currentLocation').textContent = 'Location access required';
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 60000
                }
            );
        }

        // ===== LOAD NEARBY PLACES =====
        async function loadNearbyPlaces(lat, lng) {
            const placesList = document.getElementById('placesList');
            placesList.innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <p>Searching for nearby safe places...</p>
                </div>
            `;

            try {
                // Using Overpass API directly (no server dependency)
                const overpassQuery = `
                    [out:json][timeout:25];
                    (
                      node["amenity"="police"](around:5000,${lat},${lng});
                      node["amenity"="hospital"](around:5000,${lat},${lng});
                      node["amenity"="clinic"](around:5000,${lat},${lng});
                    );
                    out body;
                    >;
                    out skel qt;
                `;

                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: overpassQuery,
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                });

                const data = await response.json();
                
                if (data.elements && data.elements.length > 0) {
                    displayPlaces(data.elements, lat, lng);
                } else {
                    placesList.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--gray);">
                            <i class="fas fa-map-marker-alt" style="font-size: 48px; margin-bottom: 15px;"></i>
                            <h3>No Safe Places Found</h3>
                            <p>No nearby police stations, hospitals, or clinics found within 5km radius.</p>
                        </div>
                    `;
                }

            } catch (error) {
                console.error('Error loading places:', error);
                placesList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--danger);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <h3>Failed to Load Places</h3>
                        <p>Please check your internet connection and try again.</p>
                    </div>
                `;
                showNotification('Failed to load safe places', 'error');
            }
        }

        // ===== DISPLAY PLACES =====
        function displayPlaces(places, userLat, userLng) {
            const placesList = document.getElementById('placesList');
            
            // Calculate distances and prepare places
            const placesWithDistance = places.map(place => {
                const distance = calculateDistance(userLat, userLng, place.lat, place.lon);
                return {
                    ...place,
                    distance: distance
                };
            });

            // Sort by distance
            placesWithDistance.sort((a, b) => a.distance - b.distance);

            // Group by type
            const policeStations = placesWithDistance.filter(p => p.tags.amenity === 'police');
            const hospitals = placesWithDistance.filter(p => p.tags.amenity === 'hospital');
            const clinics = placesWithDistance.filter(p => p.tags.amenity === 'clinic');

            let html = '';

            // Police Stations
            if (policeStations.length > 0) {
                html += `<h3 style="margin-bottom: 20px; color: var(--dark);"><i class="fas fa-shield-alt" style="color: #dc3545;"></i> Police Stations (${policeStations.length})</h3>`;
                html += policeStations.map(place => createPlaceCard(place, 'police')).join('');
            }

            // Hospitals
            if (hospitals.length > 0) {
                html += `<h3 style="margin: 30px 0 20px 0; color: var(--dark);"><i class="fas fa-hospital" style="color: #28a745;"></i> Hospitals (${hospitals.length})</h3>`;
                html += hospitals.map(place => createPlaceCard(place, 'hospital')).join('');
            }

            // Clinics
            if (clinics.length > 0) {
                html += `<h3 style="margin: 30px 0 20px 0; color: var(--dark);"><i class="fas fa-clinic-medical" style="color: #17a2b8;"></i> Clinics (${clinics.length})</h3>`;
                html += clinics.map(place => createPlaceCard(place, 'clinic')).join('');
            }

            placesList.innerHTML = html;
            
            showNotification(`Found ${places.length} safe places nearby`, 'success');
        }

        function createPlaceCard(place, type) {
            const name = place.tags.name || `${type.charAt(0).toUpperCase() + type.slice(1)} ${place.id}`;
            const address = place.tags['addr:street'] || 'Address not available';
            const phone = place.tags.phone || 'Phone not available';
            
            let icon, iconClass;
            switch(type) {
                case 'police':
                    icon = 'fa-shield-alt';
                    iconClass = 'police';
                    break;
                case 'hospital':
                    icon = 'fa-hospital';
                    iconClass = 'hospital';
                    break;
                case 'clinic':
                    icon = 'fa-clinic-medical';
                    iconClass = 'clinic';
                    break;
            }

            return `
                <div class="place-card ${type}">
                    <div class="place-header">
                        <div class="place-icon ${iconClass}">
                            <i class="fas ${icon}"></i>
                        </div>
                        <div>
                            <div class="place-name">${name}</div>
                        </div>
                    </div>
                    <div class="place-details">
                        <div class="place-address">
                            <i class="fas fa-map-marker-alt"></i> ${address}
                        </div>
                        <div class="place-distance">
                            <i class="fas fa-road"></i> ${place.distance.toFixed(2)} km away
                        </div>
                        ${phone !== 'Phone not available' ? `
                        <div style="color: var(--gray); font-size: 14px; margin-top: 5px;">
                            <i class="fas fa-phone"></i> ${phone}
                        </div>
                        ` : ''}
                    </div>
                    <div class="place-actions">
                        <button class="action-btn directions" onclick="openDirections(${place.lat}, ${place.lon})">
                            <i class="fas fa-directions"></i> Get Directions
                        </button>
                        ${phone !== 'Phone not available' ? `
                        <button class="action-btn call" onclick="callNumber('${phone}')">
                            <i class="fas fa-phone"></i> Call
                        </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // ===== UTILITY FUNCTIONS =====
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function openDirections(lat, lng) {
            const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
            window.open(url, '_blank');
        }

        function callNumber(phone) {
            // Clean phone number for tel: link
            const cleanPhone = phone.replace(/\D/g, '');
            window.open(`tel:${cleanPhone}`, '_self');
        }

        // ===== INITIALIZE SAFE PLACES =====
        function initializeSafePlaces() {
            console.log('üìç Initializing Safe Places...');
            getCurrentLocation();
        }
    </script>
</body>
</html>
